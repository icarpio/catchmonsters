<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PokÃ©City â€” Entrar</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Rajdhani', sans-serif; background: #0a0a0f; }
    .pixel { font-family: 'Press Start 2P', monospace; }
    .bg-grid {
      background-image:
        linear-gradient(rgba(250,204,21,.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(250,204,21,.04) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: gridMove 20s linear infinite;
    }
    @keyframes gridMove { 0%{background-position:0 0} 100%{background-position:40px 40px} }

    .pokeball {
      width:120px; height:120px; border-radius:50%;
      background:linear-gradient(180deg,#ef4444 50%,#fff 50%);
      border:5px solid #1f1f2e; position:relative;
      animation:float 3s ease-in-out infinite;
      box-shadow:0 20px 60px rgba(239,68,68,.3);
    }
    .pokeball::before {
      content:''; position:absolute; top:50%; left:50%;
      transform:translate(-50%,-50%);
      width:28px; height:28px; border-radius:50%;
      background:#fff; border:5px solid #1f1f2e; z-index:2;
    }
    .pokeball::after {
      content:''; position:absolute;
      top:calc(50% - 3px); left:0; right:0;
      height:6px; background:#1f1f2e;
    }
    @keyframes float {
      0%,100%{transform:translateY(0) rotate(0deg)}
      50%{transform:translateY(-16px) rotate(8deg)}
    }

    .card { background:linear-gradient(145deg,#12121f,#1a1a2e); border:1px solid #ffffff12; }
    input, select {
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1);
      color:white; transition:border-color .2s, box-shadow .2s;
    }
    input:focus, select:focus {
      outline:none; border-color:#facc15;
      box-shadow:0 0 0 3px rgba(250,204,21,.12);
    }
    input::placeholder { color:rgba(255,255,255,.3); }
    select option { background:#1a1a2e; color:white; }

    .btn-primary {
      background:linear-gradient(135deg,#facc15,#f59e0b);
      color:#0a0a0f; font-weight:800;
      transition:opacity .2s, transform .1s;
    }
    .btn-primary:hover   { opacity:.9; }
    .btn-primary:active  { transform:scale(.97); }
    .btn-primary:disabled{ opacity:.5; cursor:not-allowed; }

    .tab { transition:all .2s; border-bottom:2px solid transparent; }
    .tab.active { color:#facc15; border-color:#facc15; }

    .error-msg { animation:shake .3s ease; }
    @keyframes shake {
      0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)}
    }

    /* Ciudad seleccionada card */
    .ciudad-card {
      background:rgba(250,204,21,.08);
      border:1px solid rgba(250,204,21,.3);
      border-radius:12px; padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between;
    }
  </style>
</head>
<body class="min-h-screen bg-grid flex items-center justify-center p-4">

<div class="w-full max-w-md">
  <!-- Logo -->
  <div class="text-center mb-8">
    <div class="pokeball mx-auto mb-6"></div>
    <h1 class="pixel text-yellow-400 text-lg leading-relaxed">PokÃ©City</h1>
    <p class="text-white/40 text-sm mt-2 font-semibold">Captura pokÃ©mons por tu ciudad</p>
  </div>

  <div class="card rounded-2xl p-8">
    <!-- Tabs -->
    <div class="flex border-b border-white/10 mb-6">
      <button class="tab active flex-1 pb-3 text-sm font-bold tracking-wide" onclick="showTab('login')" id="tab-login">ENTRAR</button>
      <button class="tab flex-1 pb-3 text-white/40 text-sm font-bold tracking-wide" onclick="showTab('register')" id="tab-register">REGISTRO</button>
    </div>

    <!-- LOGIN -->
    <div id="form-login">
      <div class="space-y-4">
        <div>
          <label class="text-white/50 text-xs font-bold uppercase tracking-widest block mb-1.5">Usuario</label>
          <input id="login-username" type="text" placeholder="nombre de entrenador" class="w-full px-4 py-3 rounded-xl text-sm font-semibold"/>
        </div>
        <div>
          <label class="text-white/50 text-xs font-bold uppercase tracking-widest block mb-1.5">ContraseÃ±a</label>
          <input id="login-password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3 rounded-xl text-sm font-semibold"/>
        </div>
        <div id="login-error" class="hidden text-red-400 text-xs font-bold px-3 py-2 bg-red-500/10 rounded-lg border border-red-500/20 error-msg"></div>
        <button onclick="doLogin()" id="btn-login" class="btn-primary w-full py-3 rounded-xl text-sm tracking-widest">
          ENTRAR AL JUEGO
        </button>
      </div>
    </div>

    <!-- REGISTRO -->
    <div id="form-register" class="hidden">
      <div class="space-y-4">
        <div>
          <label class="text-white/50 text-xs font-bold uppercase tracking-widest block mb-1.5">Usuario</label>
          <input id="reg-username" type="text" placeholder="nombre de entrenador" class="w-full px-4 py-3 rounded-xl text-sm font-semibold"/>
        </div>
        <div>
          <label class="text-white/50 text-xs font-bold uppercase tracking-widest block mb-1.5">Email</label>
          <input id="reg-email" type="email" placeholder="correo@ejemplo.com" class="w-full px-4 py-3 rounded-xl text-sm font-semibold"/>
        </div>
        <div>
          <label class="text-white/50 text-xs font-bold uppercase tracking-widest block mb-1.5">ContraseÃ±a</label>
          <input id="reg-password" type="password" placeholder="mÃ­nimo 6 caracteres" class="w-full px-4 py-3 rounded-xl text-sm font-semibold"/>
        </div>
        <div>
          <label class="text-white/50 text-xs font-bold uppercase tracking-widest block mb-1.5">Confirmar contraseÃ±a</label>
          <input id="reg-password2" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full px-4 py-3 rounded-xl text-sm font-semibold"/>
        </div>

        <!-- SELECTOR DE CIUDAD -->
        <div>
          <label class="text-white/50 text-xs font-bold uppercase tracking-widest block mb-1.5">Tu ciudad ğŸŒ</label>
          <select id="reg-ciudad" class="w-full px-4 py-3 rounded-xl text-sm font-semibold">
            <option value="">Cargando ciudades...</option>
          </select>
          <!-- Preview ciudad seleccionada -->
          <div id="ciudad-preview" class="hidden mt-2 ciudad-card">
            <div>
              <p id="ciudad-nombre" class="text-yellow-400 font-bold text-sm"></p>
              <p id="ciudad-pais"   class="text-white/40 text-xs"></p>
            </div>
            <span class="text-yellow-400 text-lg">ğŸ“</span>
          </div>
        </div>

        <div id="reg-error" class="hidden text-red-400 text-xs font-bold px-3 py-2 bg-red-500/10 rounded-lg border border-red-500/20 error-msg"></div>
        <button onclick="doRegister()" id="btn-register" class="btn-primary w-full py-3 rounded-xl text-sm tracking-widest">
          ELEGIR Y JUGAR
        </button>
      </div>
    </div>
  </div>

  <p class="text-center text-white/20 text-xs mt-6">Activa el GPS para poder capturar pokÃ©mons</p>
</div>

<script src="config.js"></script>
<script>
  const API_URL = CONFIG.API_URL;
  const API = 'https://marianoapi.onrender.com/game'

if (localStorage.getItem('token')) window.location.href = 'mapa.html';

// â”€â”€ Ciudades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ciudades = [];

async function cargarCiudades() {
  try {
    const res  = await fetch(`${API}/ciudades/`);
    ciudades   = await res.json();
    const sel  = document.getElementById('reg-ciudad');
    sel.innerHTML = '<option value="">â€” Elige tu ciudad â€”</option>' +
      ciudades.map(c => `<option value="${c.id}">${c.nombre_display}${c.pais ? ' Â· ' + c.pais : ''}</option>`).join('');
  } catch {
    document.getElementById('reg-ciudad').innerHTML = '<option value="">Error cargando ciudades</option>';
  }
}

document.getElementById('reg-ciudad').addEventListener('change', function() {
  const ciudad = ciudades.find(c => c.id == this.value);
  const preview = document.getElementById('ciudad-preview');
  if (ciudad) {
    document.getElementById('ciudad-nombre').textContent = ciudad.nombre_display;
    document.getElementById('ciudad-pais').textContent   = ciudad.pais || '';
    preview.classList.remove('hidden');
  } else {
    preview.classList.add('hidden');
  }
});

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tab) {
  document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
  document.getElementById('form-register').classList.toggle('hidden', tab !== 'register');
  document.getElementById('tab-login').classList.toggle('active', tab === 'login');
  document.getElementById('tab-login').classList.toggle('text-white/40', tab !== 'login');
  document.getElementById('tab-register').classList.toggle('active', tab === 'register');
  document.getElementById('tab-register').classList.toggle('text-white/40', tab !== 'register');
}

function showError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.classList.remove('hidden');
  el.classList.remove('error-msg'); void el.offsetWidth; el.classList.add('error-msg');
}
function hideError(id) { document.getElementById(id).classList.add('hidden'); }

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doLogin() {
  hideError('login-error');
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  if (!username || !password) return showError('login-error', 'Rellena todos los campos.');

  const btn = document.getElementById('btn-login');
  btn.disabled = true; btn.textContent = 'ENTRANDO...';

  try {
    const res  = await fetch(`${API_URL}/accounts/api/auth/login/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password,source: 'pokecapture'}),
      });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Error al iniciar sesiÃ³n.');

    localStorage.setItem('token',    data.token);
    localStorage.setItem('username', data.user.username);
    // Guardar datos de ciudad para el mapa
    if (data.ciudad) {
      localStorage.setItem('ciudad_id',     data.ciudad.id);
      localStorage.setItem('ciudad_nombre', data.ciudad.nombre_display);
      localStorage.setItem('ciudad_lat',    data.ciudad.lat);
      localStorage.setItem('ciudad_lon',    data.ciudad.lon);
      localStorage.setItem('ciudad_zoom',   data.ciudad.zoom_inicial);
    }
    window.location.href = 'mapa.html';
  } catch(e) {
    showError('login-error', e.message);
    btn.disabled = false; btn.textContent = 'ENTRAR AL JUEGO';
  }
}

// â”€â”€ Registro â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doRegister() {
  hideError('reg-error');
  const username  = document.getElementById('reg-username').value.trim();
  const email     = document.getElementById('reg-email').value.trim();
  const password  = document.getElementById('reg-password').value;
  const password2 = document.getElementById('reg-password2').value;
  const ciudad_id = document.getElementById('reg-ciudad').value;

  if (!username || !email || !password) return showError('reg-error', 'Rellena todos los campos.');
  if (password !== password2)           return showError('reg-error', 'Las contraseÃ±as no coinciden.');
  if (!ciudad_id)                       return showError('reg-error', 'Elige tu ciudad para jugar.');

  const btn = document.getElementById('btn-register');
  btn.disabled = true; btn.textContent = 'CREANDO...';

  try {
    const res = await fetch(`${API_URL}/accounts/api/auth/register/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username,
        email,
        password,
        password2,
        source: 'pokecapture',                        // â† identificar la app
        extra_data: { ciudad_id: parseInt(ciudad_id) } // â† ciudad dentro de extra_data
      }),
    });

    const data = await res.json();
    if (!res.ok) throw new Error(Object.values(data).flat().join(' '));

    localStorage.setItem('token',    data.token);
    localStorage.setItem('username', data.user.username); // â† viene dentro de data.user

    if (data.ciudad) {
      localStorage.setItem('ciudad_id',     data.ciudad.id);
      localStorage.setItem('ciudad_nombre', data.ciudad.nombre_display);
      localStorage.setItem('ciudad_lat',    data.ciudad.lat);
      localStorage.setItem('ciudad_lon',    data.ciudad.lon);
      localStorage.setItem('ciudad_zoom',   data.ciudad.zoom_inicial);
    }

    window.location.href = 'mapa.html';

  } catch(e) {
    showError('reg-error', e.message);
    btn.disabled = false; btn.textContent = 'ELEGIR Y JUGAR';
  }
}

document.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  if (!document.getElementById('form-login').classList.contains('hidden')) doLogin();
  else doRegister();
});

cargarCiudades();
</script>
</body>
</html>